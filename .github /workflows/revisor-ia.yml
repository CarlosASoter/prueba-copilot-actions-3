- name: Revisi√≥n de Seguridad
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    BASE_REF: ${{ github.base_ref }}
  run: |
    python - <<'EOF'
    import os
    import subprocess
    import requests
    from openai import OpenAI

    client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

    # Obtener diff
    base_branch = os.environ.get("BASE_REF", "main")
    subprocess.run(f"git fetch origin {base_branch}", shell=True)
    try:
        diff = subprocess.check_output(f"git diff origin/{base_branch}...HEAD", shell=True, text=True)
    except:
        diff = ""

    if not diff.strip():
        print("Sin cambios para analizar.")
        exit(0)

    prompt = f"Eres un experto en seguridad. Analiza este diff y reporta fallos graves en espa√±ol:\n\n{diff}"

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo", 
            messages=[
                {"role":"system","content":"Eres un experto en seguridad."},
                {"role":"user","content":prompt}
            ],
            max_tokens=500
        )
        feedback = response.choices[0].message.content

        # Publicar comentario en GitHub
        repo = os.environ['GITHUB_REPOSITORY']
        pr_number = os.environ['GITHUB_REF'].split('/')[-2]
        url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"

        headers = {
            "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
            "Accept": "application/vnd.github.v3+json"
        }

        res = requests.post(url, json={"body": f"### üõ°Ô∏è Auditor√≠a OpenAI\n\n{feedback}"}, headers=headers)

        if res.status_code == 201:
            print("‚úÖ Comentario publicado.")
        else:
            print(f"‚ùå Error GitHub: {res.status_code} - {res.text}")

    except Exception as e:
        print(f"‚ùå ERROR: {e}")
    EOF
