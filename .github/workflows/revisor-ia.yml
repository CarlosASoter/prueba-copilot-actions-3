- name: Revisi√≥n de Seguridad
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    BASE_REF: ${{ github.base_ref }}
  run: |
    python - <<'EOF'
    import os
    import subprocess
    import requests
    from openai import OpenAI

    # 1. Cliente OpenAI
    client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

    # 2. Modelo recomendado
    # - gpt-4.1-mini ‚Üí barato y suficiente para auditor√≠as
    MODEL_ID = "gpt-4.1-mini"

    # 3. Obtener el diff del PR
    base_branch = os.environ.get("BASE_REF", "main")
    subprocess.run(f"git fetch origin {base_branch}", shell=True)

    try:
        diff = subprocess.check_output(
            f"git diff origin/{base_branch}...HEAD",
            shell=True,
            text=True
        )
    except Exception:
        diff = ""

    if not diff.strip():
        print("Sin cambios para analizar.")
        exit(0)

    # 4. Prompt de seguridad
    prompt = f"""
    Eres un auditor experto en seguridad de software.
    Analiza el siguiente diff de un Pull Request y reporta
    √∫nicamente vulnerabilidades graves o cr√≠ticas.
    Responde en espa√±ol, de forma clara y accionable.

    DIFF:
    {diff}
    """

    try:
        print(f"Usando modelo: {MODEL_ID}")

        response = client.chat.completions.create(
            model=MODEL_ID,
            messages=[
                {"role": "system", "content": "Eres un experto en ciberseguridad."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.2
        )

        feedback = response.choices[0].message.content

        # 5. Publicar comentario en el PR
        repo = os.environ["GITHUB_REPOSITORY"]
        pr_number = os.environ["GITHUB_REF"].split("/")[-2]
        url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"

        headers = {
            "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
            "Accept": "application/vnd.github.v3+json"
        }

        body = f"### üõ°Ô∏è Auditor√≠a de Seguridad (OpenAI)\n\n{feedback}"
        res = requests.post(url, json={"body": body}, headers=headers)

        if res.status_code == 201:
            print("‚úÖ Comentario publicado.")
        else:
            print(f"‚ùå Error GitHub: {res.status_code} - {res.text}")

    except Exception as e:
        print(f"‚ùå ERROR: {e}")
    EOF
