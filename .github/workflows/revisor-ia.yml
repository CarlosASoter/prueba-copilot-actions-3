name: Revisor IA

on:
  pull_request:

jobs:
  revision-seguridad:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Instalar dependencias Python
      - name: Instalar dependencias Python
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade openai requests

      # 3Ô∏è‚É£ Test de OpenAI Key y cuota
      - name: Verificar OpenAI Key y cuota
        id: test_key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - <<'EOF'
          import openai, os
          try:
              # Llamada m√≠nima para probar la key
              client = openai.OpenAI(api_key=os.environ["OPENAI_API_KEY"])
              client.chat.completions.create(
                  model="gpt-3.5-turbo",
                  messages=[{"role":"user","content":"Test"}],
                  max_tokens=10
              )
              print("‚úÖ Key v√°lida y hay tokens disponibles")
              exit(0)
          except openai.OpenAIError as e:
              if getattr(e, "code", None) == "insufficient_quota":
                  print("‚ùå No hay tokens disponibles")
                  exit(1)
              else:
                  print(f"‚ùå ERROR OpenAI inesperado: {e}")
                  exit(1)
          EOF

      # 4Ô∏è‚É£ Revisi√≥n de seguridad solo si la key funciona
      - name: Revisi√≥n de Seguridad
        if: success()  # Se ejecuta solo si el step anterior tuvo √©xito
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          python - <<'EOF'
          import os
          import subprocess
          import requests
          import openai

          client = openai.OpenAI(api_key=os.environ["OPENAI_API_KEY"])

          # Obtener diff entre el branch base y HEAD
          base_branch = os.environ.get("BASE_REF", "main")
          subprocess.run(f"git fetch origin {base_branch}", shell=True)
          try:
              diff = subprocess.check_output(f"git diff origin/{base_branch} HEAD", shell=True, text=True)
          except:
              diff = ""

          if not diff.strip():
              print("Sin cambios para analizar.")
              exit(0)

          # Truncar diff para ahorrar tokens
          MAX_DIFF_CHARS = 4000
          diff = diff[:MAX_DIFF_CHARS]

          prompt = f"Eres un experto en seguridad. Analiza este diff y reporta fallos graves en espa√±ol:\n\n{diff}"

          try:
              response = client.chat.completions.create(
                  model="gpt-3.5-turbo",
                  messages=[
                      {"role": "system", "content": "Eres un experto en seguridad."},
                      {"role": "user", "content": prompt}
                  ],
                  max_tokens=250
              )
              feedback = response.choices[0].message.content

              # Publicar comentario en GitHub
              repo = os.environ['GITHUB_REPOSITORY']
              pr_number = os.environ['GITHUB_REF'].split('/')[-2]
              url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"

              headers = {
                  "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
                  "Accept": "application/vnd.github.v3+json"
              }

              res = requests.post(url, json={"body": f"### üõ°Ô∏è Auditor√≠a OpenAI\n\n{feedback}"}, headers=headers)

              if res.status_code == 201:
                  print("‚úÖ Comentario publicado.")
              else:
                  print(f"‚ùå Error GitHub: {res.status_code} - {res.text}")

          except openai.OpenAIError as e:
              if getattr(e, "code", None) == "insufficient_quota":
                  print("‚ùå No hay tokens suficientes, se omite auditor√≠a")
              else:
                  print(f"‚ùå ERROR OpenAI inesperado: {e}")
          except Exception as e:
              print(f"‚ùå ERROR inesperado: {e}")
          EOF
