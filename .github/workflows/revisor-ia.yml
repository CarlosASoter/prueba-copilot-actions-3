name: Revisor IA de Seguridad

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  security-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          pip install --upgrade openai requests

      - name: Revisi√≥n de Seguridad (OpenAI)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          python - <<'EOF'
          import os
          import subprocess
          import requests
          from openai import OpenAI

          client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])
          MODEL_ID = "GPT-3.5 Turbo"

          base_branch = os.environ.get("BASE_REF", "main")
          subprocess.run(f"git fetch origin {base_branch}", shell=True)

          try:
              diff = subprocess.check_output(
                  f"git diff origin/{base_branch}...HEAD",
                  shell=True,
                  text=True
              )
          except Exception:
              diff = ""

          if not diff.strip():
              print("Sin cambios para analizar.")
              exit(0)

          prompt = f"""
          Eres un auditor experto en seguridad de software.
          Analiza el siguiente diff y reporta SOLO vulnerabilidades graves o cr√≠ticas.
          Responde en espa√±ol, de forma clara y accionable.

          DIFF:
          {diff}
          """

          response = client.chat.completions.create(
              model=MODEL_ID,
              messages=[
                  {"role": "system", "content": "Eres un experto en ciberseguridad."},
                  {"role": "user", "content": prompt}
              ],
              temperature=0.2
          )

          feedback = response.choices[0].message.content

          repo = os.environ["GITHUB_REPOSITORY"]
          pr_number = os.environ["GITHUB_REF"].split("/")[-2]
          url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"

          headers = {
              "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
              "Accept": "application/vnd.github.v3+json"
          }

          body = f"### üõ°Ô∏è Auditor√≠a de Seguridad (OpenAI)\n\n{feedback}"
          res = requests.post(url, json={"body": body}, headers=headers)

          if res.status_code == 201:
              print("‚úÖ Comentario publicado.")
          else:
              print(f"‚ùå Error GitHub: {res.status_code} - {res.text}")
          EOF
